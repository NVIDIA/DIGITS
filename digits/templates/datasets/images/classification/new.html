{# Copyright (c) 2014-2015, NVIDIA CORPORATION.  All rights reserved. #}

{% from "helper.html" import print_flashes %}
{% from "helper.html" import print_errors %}

{% extends "layout.html" %}

{% block title %}
New Image Classification Dataset
{% endblock %}

{% block nav %}
<li class="active"><a href="{{url_for('image_classification_dataset_new')}}">New Dataset</a></li>
{% endblock %}

{% block content %}

<div class="page-header">
    <h1>New Image Classification Dataset</h1>
</div>

<form action="{{url_for('image_classification_dataset_create')}}" enctype="multipart/form-data" method="post">
    {{ form.hidden_tag() }}

    {{ print_errors(form) }}

    <div class="row">
        <div class="col-sm-4 well">
            <div class="row">
                <div class="form-group{{ ' has-error' if form.resize_channels.errors else '' }}">
                    {{ form.resize_channels.label }}
                    {{ form.resize_channels.tooltip }}
                    {{ form.resize_channels(class='form-control') }}
                </div>
            </div>
            <div class="row">
                <div class="form-group{{ ' has-error' if form.resize_width.errors or form.resize_height.errors else '' }}">
                    <label>Image size</label>
                    <span name="resize_dims_explanation"
                          class="explanation-tooltip glyphicon glyphicon-question-sign"
                          data-container="body"
                          title="Input images will be resized to fit."
                          ></span>
                    <div class="input-group">
                        {{ form.resize_width(size=4, placeholder='width', class='form-control') }}
                        <span class="input-group-addon">x</span>
                        {{ form.resize_height(size=4, placeholder='height', class='form-control') }}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group{{ ' has-error' if form.resize_mode.errors else '' }}">
                    {{ form.resize_mode.label }}
                    {{ form.resize_mode.tooltip }}
                    {{ form.resize_mode(class='form-control') }}
                </div>
            </div>
            <div class="row">
                <a class="btn btn-info" href="#" onClick="return showResizeExample();">See example</a>
                <br>
                <br>
                <div id="resize-example" style="display:none;">
                    <button class="close" onClick="$('#resize-example').hide();return false;">&times;</button>
                    <div id="resize-example-image"></div>
                </div>
                <script>
function showResizeExample()
{
    $.post(
            "{{url_for('image_dataset_resize_example')}}",
            {
                "channels": $("#resize_channels").val(),
                "width":    $("#resize_width").val(),
                "height":   $("#resize_height").val(),
                "resize_mode":   $("#resize_mode").val(),
                "backend": $("#backend").val(),
                "encoding": $("#encoding").val(),
            },
            function(response) {
                $('#resize-example-image').html(response);
                $('#resize-example').show();
            }
        );
    return false;
}
                </script>
            </div>
        </div>

        <div class="col-sm-8">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" id="db-tabs" role="tablist">
                <li><a href="#db-folder" role="tab" data-toggle="tab">Use Image Folder</a></li>
                <li><a href="#db-textfile" role="tab" data-toggle="tab">Use Text Files</a></li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content well">
                <!-- Folder -->
                <div class="tab-pane" id="db-folder">
                    <div class="form-group{{ ' has-error' if form.folder_train.errors else '' }}">
                        {{ form.folder_train.label }}
                        {{ form.folder_train.tooltip }}
                        {{ form.folder_train(class='form-control autocomplete_path', placeholder='folder or URL')}}
                    </div>
                    <div class="row">
                        <div class="col-sm-10 col-sm-offset-1">
                            <small>
                            </small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-sm-6{{ ' has-error' if form.folder_train_min_per_class.errors else '' }}">
                            {{ form.folder_train_min_per_class.label }}
                            {{ form.folder_train_min_per_class.tooltip }}
                            {{ form.folder_train_min_per_class(class='form-control') }}
                        </div>
                        <div class="form-group col-sm-6{{ ' has-error' if form.folder_train_max_per_class.errors else '' }}">
                            {{ form.folder_train_max_per_class.label }}
                            {{ form.folder_train_max_per_class.tooltip }}
                            {{ form.folder_train_max_per_class(class='form-control') }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-sm-6{{ ' has-error' if form.folder_pct_val.errors else '' }}">
                            {{ form.folder_pct_val.label }}
                            {{ form.folder_pct_val.tooltip }}
                            {{ form.folder_pct_val(class='form-control') }}
                        </div>
                        <div class="form-group col-sm-6{{ ' has-error' if form.folder_pct_test.errors else '' }}">
                            {{ form.folder_pct_test.label }}
                            {{ form.folder_pct_test.tooltip }}
                            {{ form.folder_pct_test(class='form-control') }}
                        </div>
                    </div>
                    <br>
                    {{form.has_val_folder}}
                    {{form.has_val_folder.label}}
                    <div style="display:none;" class="form-group{{ ' has-error' if form.folder_val.errors else '' }} cl-separate-val-folder">
                        {{ form.folder_val.label }}
                        {{ form.folder_val(class='form-control autocomplete_path') }}
                    </div>
                    <div class="row cl-separate-val-folder">
                        <div class="form-group col-sm-6{{ ' has-error' if form.folder_val_min_per_class.errors else '' }}">
                            {{ form.folder_val_min_per_class.label }}
                            {{ form.folder_val_min_per_class.tooltip }}
                            {{ form.folder_val_min_per_class(class='form-control') }}
                        </div>
                        <div class="form-group col-sm-6{{ ' has-error' if form.folder_val_max_per_class.errors else '' }}">
                            {{ form.folder_val_max_per_class.label }}
                            {{ form.folder_val_max_per_class.tooltip }}
                            {{ form.folder_val_max_per_class(class='form-control') }}
                        </div>
                    </div>
                    <script>
function hasValFolderChanged() {
    if ($("#has_val_folder").prop("checked"))
    {
        $("#folder_val").prop("disabled", false);
        $(".cl-separate-val-folder").show();
        $("#folder_pct_val").prop("disabled", true);
    }
    else
    {
        $(".cl-separate-val-folder").hide();
        $("#folder_val").prop("disabled", true);
        $("#folder_pct_val").prop("disabled", false);
    }
}
$("#has_val_folder").click(hasValFolderChanged);
hasValFolderChanged();
                    </script>
                    <br>
                    {{form.has_test_folder}}
                    {{form.has_test_folder.label}}
                    <div style="display:none;" class="form-group{{ ' has-error' if form.folder_test.errors else '' }} cl-separate-test-folder">
                        {{ form.folder_test.label }}
                        {{ form.folder_test(class='form-control autocomplete_path') }}
                    </div>
                    <div style="display:none;" class="row cl-separate-test-folder">
                        <div class="form-group col-sm-6{{ ' has-error' if form.folder_test_min_per_class.errors else '' }}">
                            {{ form.folder_test_min_per_class.label }}
                            {{ form.folder_test_min_per_class.tooltip }}
                            {{ form.folder_test_min_per_class(class='form-control') }}
                        </div>
                        <div class="form-group col-sm-6{{ ' has-error' if form.folder_test_max_per_class.errors else '' }}">
                            {{ form.folder_test_max_per_class.label }}
                            {{ form.folder_test_max_per_class.tooltip }}
                            {{ form.folder_test_max_per_class(class='form-control') }}
                        </div>
                    </div>
                    <script>
function hasTestFolderChanged() {
    if ($("#has_test_folder").prop("checked"))
    {
        $("#folder_test").prop("disabled", false);
        $(".cl-separate-test-folder").show();
        $("#folder_pct_test").prop("disabled", true);
    }
    else
    {
        $(".cl-separate-test-folder").hide();
        $("#folder_test").prop("disabled", true);
        $("#folder_pct_test").prop("disabled", false);
    }
}
$("#has_test_folder").click(hasTestFolderChanged);
hasTestFolderChanged();
                    </script>
                </div>
                <!-- Textfile -->
                <div class="tab-pane" id="db-textfile">
                    <div class="row">
                        <table class="table">
                            <tr>
                                <th width="20%">Set</th>

                                <th width="40%">Text file <span name="text_file_explanation"
                          class="explanation-tooltip glyphicon glyphicon-question-sign"
                                    data-container="body"
                                    title="Each line in the file should be formatted as '<PATH> <LABEL>' where <PATH> specifies image path either on the local filesystem or a URL, and the <LABEL> is a numeric label that matches the uploaded labels file"
                                ></span></th>

                                <th width="40%">Image folder <i>(optional)</i> <span name="image_folder_explanation"
                                    class="explanation-tooltip glyphicon glyphicon-question-sign"
                                    data-container="body"
                                    title="Paths in the text files will be appended with this value before reading"
                                ></span></th>
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <label for="{{form.textfile_use_local_files.name}}">
                                        {{form.textfile_use_local_files}}
                                        Use local paths on server
                                    </label>
                                    <span name="text_file_explanation"
                                          class="explanation-tooltip glyphicon glyphicon-question-sign"
                                          data-container="body"
                                          title="Check to use local paths on server, uncheck to upload files from client machine"
                                    ></span>
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td><b>Training</b></td>
                                <td class="form-group{{' has-error' if form.textfile_train_images.errors}} cl-upload-files">
                                    {{ form.textfile_train_images(class='form-control') }}
                                </td>
                                <td class="form-group{{' has-error' if form.textfile_local_train_images.errors}} cl-local-files">
                                    {{ form.textfile_local_train_images(class='form-control autocomplete_path',placeholder='enter path') }}
                                </td>
                                <td class="form-group{{' has-error' if form.textfile_train_folder.errors}}">
                                    {{ form.textfile_train_folder(class='form-control autocomplete_path') }}
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label for="{{form.textfile_use_val.name}}">
                                        {{form.textfile_use_val}}
                                        Validation
                                    </label>
                                </td>
                                <td class="form-group{{' has-error' if form.textfile_val_images.errors}} cl-upload-files">
                                    {{ form.textfile_val_images(class='form-control') }}
                                </td>
                                <td class="form-group{{' has-error' if form.textfile_local_val_images.errors}} cl-local-files">
                                    {{ form.textfile_local_val_images(class='form-control autocomplete_path',placeholder='enter path') }}
                                </td>
                                <td class="form-group{{' has-error' if form.textfile_val_folder.errors}}">
                                    {{ form.textfile_val_folder(class='form-control autocomplete_path') }}
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label for="{{form.textfile_use_test.name}}">
                                        {{form.textfile_use_test}}
                                        Test
                                    </label>
                                </td>
                                <td class="form-group{{' has-error' if form.textfile_test_images.errors}} cl-upload-files">
                                    {{ form.textfile_test_images(class='form-control') }}
                                </td>
                                <td class="form-group{{' has-error' if form.textfile_local_test_images.errors}} cl-local-files">
                                    {{ form.textfile_local_test_images(class='form-control autocomplete_path',placeholder='enter path') }}
                                </td>
                                <td class="form-group{{' has-error' if form.textfile_test_folder.errors}}">
                                    {{ form.textfile_test_folder(class='form-control autocomplete_path') }}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="row">
                        <div class="col-sm-6 col-sm-offset-1">
                            <div class="form-group{{ ' has-error' if form.textfile_shuffle.errors else '' }}">
                                {{ form.textfile_shuffle.label }}
                                {{ form.textfile_shuffle.tooltip }}
                                {{ form.textfile_shuffle(class='form-control') }}
                            </div>
                            <div class="form-group{{ ' has-error' if form.textfile_labels_file.errors else '' }} cl-upload-files">
                                {{ form.textfile_labels_file.label }}
                                {{ form.textfile_labels_file.tooltip }}
                                {{ form.textfile_labels_file(class='form-control') }}
                            </div>
                            <div class="form-group{{ ' has-error' if form.textfile_local_labels_file.errors else '' }} cl-local-files">
                                {{ form.textfile_local_labels_file.label }}
                                {{ form.textfile_local_labels_file.tooltip }}
                                {{ form.textfile_local_labels_file(class='form-control autocomplete_path',placeholder='enter path') }}
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    {{ form.method(style="display:none;") }}
    <script>
// Disable form fields according to the checkboxes
function textfile_image_sets_disabled() {
    var value = $("#textfile_use_val").prop("checked");
    var useLocalFiles = $("#textfile_use_local_files").prop("checked");
    if (useLocalFiles) {
        $(".cl-upload-files").hide();
        $(".cl-local-files").show();
    }
    else{
        $(".cl-upload-files").show();
        $(".cl-local-files").hide();
    }

     if (value) {
         $("#textfile_val_images_btn").removeClass("disabled");
     } else {
         $("#textfile_val_images_btn").addClass("disabled");
     }

    $("#textfile_val_images_text").prop("disabled", !value);
    $("#textfile_local_val_images").prop("disabled", !value);
    $("#textfile_val_folder").prop("disabled", !value);
    value = $("#textfile_use_test").prop("checked");

     if (value) {
         $("#textfile_test_images_btn").removeClass("disabled");
     } else {
         $("#textfile_test_images_btn").addClass("disabled");
     }

    $("#textfile_test_images_text").prop("disabled", !value);
    $("#textfile_local_test_images").prop("disabled", !value);
    $("#textfile_test_folder").prop("disabled", !value);
}

$("#textfile_use_val").click(function() {
        textfile_image_sets_disabled();
        });
$("#textfile_use_test").click(function() {
        textfile_image_sets_disabled();
        });
$("#textfile_use_local_files").click(function() {
        textfile_image_sets_disabled();
        });
textfile_image_sets_disabled();

function update_db_tab(tabName) {
    $('select[name=method]').val( tabName );
}
$('#db-tabs a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
        parts = e.target.href.split('-');
        update_db_tab( parts[parts.length-1] );
        });
$('#db-tabs a[href="#db-{{ form.method.data }}"]').tab('show');

    </script>

    <div class="row">
        <div class="col-sm-4 well">
            <!-- Dataset augmentation -->
            <h4>Dataset augmentation</h4>
            <!-- Rotation -->
            {{form.has_augmentation_rotation}}
            {{form.has_augmentation_rotation.label}}
            {{form.has_augmentation_rotation.tooltip}} 
            <div class="row cl-augmentation-rotation">
                <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_rotation_angle_min.errors else '' }}">
                    {{ form.augmentation_rotation_angle_min.label }}
                    {{ form.augmentation_rotation_angle_min.tooltip }}
                    {{ form.augmentation_rotation_angle_min(class='form-control') }}
                </div>
                <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_rotation_angle_max.errors else '' }}">
                    {{ form.augmentation_rotation_angle_max.label }}
                    {{ form.augmentation_rotation_angle_max.tooltip }}
                    {{ form.augmentation_rotation_angle_max(class='form-control') }}
                </div>
                <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_rotation_probability.errors else '' }}">
                    {{ form.augmentation_rotation_probability.label }}
                    {{ form.augmentation_rotation_probability.tooltip }}
                    {{ form.augmentation_rotation_probability(class='form-control') }}
                </div>
            </div>
<script>
function hasAugmentationRotationChanged() {
    if ($("#has_augmentation_rotation").prop("checked"))
    {
        $(".cl-augmentation-rotation").show();
    }
    else
    {
        $(".cl-augmentation-rotation").hide();
    }
}
$("#has_augmentation_rotation").click(hasAugmentationRotationChanged);
hasAugmentationRotationChanged();
</script>            
            <!-- Hue -->
            <br>
            {{form.has_augmentation_hue}}
            {{form.has_augmentation_hue.label}} 
            {{form.has_augmentation_hue.tooltip}} 
            <div class="row cl-augmentation-hue">
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_hue_angle_min.errors else '' }}">
                    {{ form.augmentation_hue_angle_min.label }}
                    {{ form.augmentation_hue_angle_min.tooltip }}
                    {{ form.augmentation_hue_angle_min(class='form-control') }}
                </div>
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_hue_angle_max.errors else '' }}">
                    {{ form.augmentation_hue_angle_max.label }}
                    {{ form.augmentation_hue_angle_max.tooltip }}
                    {{ form.augmentation_hue_angle_max(class='form-control') }}
                </div>
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_hue_probability.errors else '' }}">
                    {{ form.augmentation_hue_probability.label }}
                    {{ form.augmentation_hue_probability.tooltip }}
                    {{ form.augmentation_hue_probability(class='form-control') }}
                </div>
            </div>
<script>
function hasAugmentationHueChanged() {
    if ($("#has_augmentation_hue").prop("checked"))
    {
        $(".cl-augmentation-hue").show();
    }
    else
    {
        $(".cl-augmentation-hue").hide();
    }
}
$("#has_augmentation_hue").click(hasAugmentationHueChanged);
hasAugmentationHueChanged();
</script>
            <!-- Contrast -->
            <br>
            {{form.has_augmentation_contrast}}
            {{form.has_augmentation_contrast.label}} 
            {{form.has_augmentation_contrast.tooltip}} 
            <div class="row cl-augmentation-contrast">
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_contrast_strength_min.errors else '' }}">
                    {{ form.augmentation_contrast_strength_min.label }}
                    {{ form.augmentation_contrast_strength_min.tooltip }}
                    {{ form.augmentation_contrast_strength_min(class='form-control') }}
                </div>
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_contrast_strength_max.errors else '' }}">
                    {{ form.augmentation_contrast_strength_max.label }}
                    {{ form.augmentation_contrast_strength_max.tooltip }}
                    {{ form.augmentation_contrast_strength_max(class='form-control') }}
                </div>
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_contrast_probability.errors else '' }}">
                    {{ form.augmentation_contrast_probability.label }}
                    {{ form.augmentation_contrast_probability.tooltip }}
                    {{ form.augmentation_contrast_probability(class='form-control') }}
                </div>
            </div>
<script>
function hasAugmentationContrastChanged() {
    if ($("#has_augmentation_contrast").prop("checked"))
    {
        $(".cl-augmentation-contrast").show();
    }
    else
    {
        $(".cl-augmentation-contrast").hide();
    }
}
$("#has_augmentation_contrast").click(hasAugmentationContrastChanged);
hasAugmentationContrastChanged();
</script> 
            <!-- Translation -->
            <br>
            {{form.has_augmentation_translation}}
            {{form.has_augmentation_translation.label}} 
            {{form.has_augmentation_translation.tooltip}} 
            <div class="row cl-augmentation-translation">
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_translation_dx_min.errors else '' }}">
                    {{ form.augmentation_translation_dx_min.label }}
                    {{ form.augmentation_translation_dx_min.tooltip }}
                    {{ form.augmentation_translation_dx_min(class='form-control') }}
                </div>
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_translation_dx_max.errors else '' }}">
                    {{ form.augmentation_translation_dx_max.label }}
                    {{ form.augmentation_translation_dx_max.tooltip }}
                    {{ form.augmentation_translation_dx_max(class='form-control') }}
                </div>
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_translation_dy_min.errors else '' }}">
                    {{ form.augmentation_translation_dy_min.label }}
                    {{ form.augmentation_translation_dy_min.tooltip }}
                    {{ form.augmentation_translation_dy_min(class='form-control') }}
                </div>
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_translation_dy_max.errors else '' }}">
                    {{ form.augmentation_translation_dy_max.label }}
                    {{ form.augmentation_translation_dy_max.tooltip }}
                    {{ form.augmentation_translation_dy_max(class='form-control') }}
                </div>
                 <div class="form-group col-sm-6{{ ' has-error' if form.augmentation_translation_probability.errors else '' }}">
                    {{ form.augmentation_translation_probability.label }}
                    {{ form.augmentation_translation_probability.tooltip }}
                    {{ form.augmentation_translation_probability(class='form-control') }}
                </div>
            </div>
<script>
function hasAugmentationTranslationChanged() {
    if ($("#has_augmentation_translation").prop("checked"))
    {
        $(".cl-augmentation-translation").show();
    }
    else
    {
        $(".cl-augmentation-translation").hide();
    }
}
$("#has_augmentation_translation").click(hasAugmentationTranslationChanged);
hasAugmentationTranslationChanged();
</script> 
        </div> 
        <div class="col-sm-6 col-sm-offset-1 well">
            <div class="form-group{{ ' has-error' if form.backend.errors else '' }}">
                {{ form.backend.label }}
                {{ form.backend.tooltip }}
                {{ form.backend(class='form-control') }}
            </div>
            <div id="backend-hdf5-warning" class="alert alert-warning" style="display:none;">
                <b>NOTE:</b> HDF5 is not fully supported by Caffe or by DIGITS
                <ul>
                    <li>The standard networks will need some minor customizations before use (change <i>Data</i> layers to <i>HDF5Data</i> layers)</li>
                    <li><i>HDF5Data</i> layers do not support mean subtraction</li>
                </ul>
            </div>
            <div class="form-group{{ ' has-error' if form.compression.errors else '' }}">
                <div class="form-group{{' has-error' if form.compression.errors}}">
                    {{form.compression.label}}
                    {{form.compression.tooltip}}
                    {{form.compression(class='form-control')}}
                </div>
            </div>
            <div class="form-group{{ ' has-error' if form.encoding.errors else '' }}">
                <div class="form-group{{' has-error' if form.encoding.errors}}">
                    {{form.encoding.label}}
                    {{form.encoding.tooltip}}
                    {{form.encoding(class='form-control')}}
                </div>
            </div>
            <script>
function backendChanged()
{
    val = $("#backend").val();
    if (val == 'lmdb') {
        $("#compression").parent().hide();
        $("#encoding").parent().show();
        $("#backend-hdf5-warning").hide();
    } else if (val == 'hdf5') {
        $("#encoding").parent().hide();
        $("#compression").parent().show();
        $("#backend-hdf5-warning").show();
    }
}
$("#backend").change(backendChanged);
backendChanged();
            </script>
            <div class="form-group{{ ' has-error' if form.dataset_name.errors else '' }}">
                {{ form.dataset_name.label }}
                {{ form.dataset_name(class='form-control') }}
            </div>
            <input type="submit" name="create-dataset" class="btn btn-primary" value="Create">
        </div>
    </div>

</form>

<script>
$(".explanation-tooltip").tooltip();
</script>

{% endblock %}
